#!/usr/bin/env python3
# -*- coding: utf-8 -*-

import json
import os
import re
import time
import urllib.request

from json.decoder import JSONDecodeError

from lib.core.common import intelOpen
from lib.core.data import logger

__data_path__ = os.path.join('data', 'cmd5.json')
__user_agent__ = r'''Mozilla/5.0 (X11; Linux x86_64; rv:45.0) Gecko/20100101 Firefox/45.0'''
__fail_string__ = ['已查到,这是一条付费记录',
                    '未查到,已加入本站后台解密']

def cmd5(password):
    viewstate = getViewState()

    logger.debug('sleep 5 seconds to avoid being abandoned...')
    time.sleep(5)
    logger.debug('use __VIEWSTATE to request origin text from http://www.cmd5.com/...')

    values = {'__VIEWSTATE' : viewstate,
                'ctl00$ContentPlaceHolder1$TextBoxInput' : password,
                'ctl00$ContentPlaceHolder1$Button1' : '查询'}
    data = urllib.parse.urlencode(values).encode()
    req = urllib.request.Request('http://www.cmd5.com/', headers = {'User-Agent' : __user_agent__})
    req.add_header('Referer', 'http://www.cmd5.com/')
    req.data = data

    response = urllib.request.urlopen(req)
    html = response.read().decode()
    origin = re.search(r'''(?s)<span id="ctl00_ContentPlaceHolder1_LabelAnswer">(.+?)</span>''', html).groups()[0]
    
    # get rid of html tags
    origin = re.sub(r'''<[^>]*?>''', '', origin)

    origin = re.sub(r'''(\r|\n)''', '', origin)
    logger.info('the result from cmd5 is ' + origin)
    for _ in __fail_string__:
        if _ in origin:
            return ''
    
    return origin

def getViewState():
    try:
        with intelOpen(__data_path__, 'r') as data_file:
            viewstate = json.load(data_file)['__VIEWSTATE']
            logger.debug("get __VIEWSTATE from cache file : {!s}".format(viewstate))
            return viewstate
    except (FileNotFoundError, JSONDecodeError):
        with intelOpen(__data_path__, 'w') as data_file:
            json.dump(dict(), data_file)
    except KeyError:
        pass
        
    logger.debug('retrieving __VIEWSTATE from http://www.cmd5.com/...')
    req = urllib.request.Request('http://www.cmd5.com/', headers = {'User-Agent' : __user_agent__})
    response = urllib.request.urlopen(req)
    html = response.read().decode()
    viewstate = re.search(r'''<input type="hidden" name="__VIEWSTATE" id="__VIEWSTATE" value="([^"]+?)" />''', html).groups()[0]
    logger.debug('retrieved the __VIEWSTATE is {!s}'.format(viewstate))
    
    # make cache
    with intelOpen(__data_path__, 'r') as data_file:
        data = json.load(data_file)
    data['__VIEWSTATE'] = viewstate
    with intelOpen(__data_path__, 'w') as data_file:
        json.dump(data, data_file)

    return viewstate
