#!/usr/bin/env python3
# -*- coding: utf-8 -*-

import importlib
import os

from lib.core.data import logger
from lib.core.settings import PASSWORD_SUPPORTED

def searchPasswordSupported():
    """
    plugins/*.py we search to append to list PASSWORD_SUPPORTED
    """
    for mod in os.listdir('plugins'):
        if os.path.isfile(os.path.join('plugins', mod)):   # whether mod is a file
            mod_name, mod_ext = os.path.splitext(mod)
            if mod_ext == ".py":    # whether mod is a python file
                if mod_name.isidentifier():     # whether mod's name is an identifier
                    PASSWORD_SUPPORTED.append(mod_name)

def identifyPasswordType(password, password_type = None):
    # whether force the password type
    if password_type is not None:
        if password_type not in PASSWORD_SUPPORTED:
            logger.warn("unsupported password type({!s}) detected, identify "
                            "password type automatically".format(password_type))
        else:
            logger.info("force password type to {!s}".format(password_type))
            mod = importlib.import_module('plugins.{!s}'.format(password_type))
            cls = eval('mod.{!s}'.format(mod.__name__))
            return cls, password_type

    # identify password type
    logger.debug('identifying password type of {!s}...'.format(password))

    for ps in PASSWORD_SUPPORTED:
        logger.debug('check password type {!s}...'.format(ps))
        mod = importlib.import_module('plugins.{!s}'.format(ps))
        cls = eval('mod.{!s}'.format(ps))
        if cls.identify(password):
            logger.info('type of {!s} is {!s}'.format(password, ps))
            return cls, ps
        else:
            logger.debug('type of {!s} *is NOT* {!s}'.format(password, ps))

    logger.warn("can't identify password type of {!s}".format(password))
    return None, None

def intelOpen(path, mode):
    """
    intelligent open function, open path with mode, if dirname of path
    isn't exists, create it automatically
    """
    basedir = os.path.dirname(path)
    if not os.path.isdir(basedir):
        os.mkdirs(basedir)
    return open(path, mode)
