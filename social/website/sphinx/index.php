<?php
	error_reporting(0);	//关闭错误提示
	require ( "sphinxapi.php" );	//spinix搜索引擎
	
	$num = 0;	//本页的条目
	$rets = null;	//用于保存返回最多PAGE_NUM个结果集
	$page = 0;	//从某处开始检索
	$quest = strip_tags(trim($_GET['quest']));
	$md5 = strip_tags(trim($_GET['md5']));
	$full = strip_tags(trim($_GET['full']));
	
	const SERVER_PORT = 9312;	//Sphinx服务端口
	const CONNECT_TIMEOUT = 30;	//连接超时设置
	const PAGE_NUM = 10;	//单页最大显示数目
	const MAX_NUM = 200;	//需与 csft.conf 设置的最大返回结果数相同
	const DATABASE = "mydata";	//数据库库名
	const USERNAME = "root";	//数据库用户名
	const PASSWORD = "";	//数据库密码
	
	//定义 table_id 对应的表名
	$table["1"] = "bbs_ucenter_members";
	$table["2"] = "bm_list";
	$table["3"] = "cn12306";
	$table["4"] = "gfan";
	$table["5"] = "house";
	$table["6"] = "mail126";
	$table["7"] = "police1";
	$table["8"] = "police2";
	$table["9"] = "pre_ucenter_members";
	$table["10"] = "pre_ucenter_members2";
	$table["11"] = "pre_ucenter_members3";
	$table["12"] = "rhs_users";
	$table["13"] = "sdo1000w";
	$table["14"] = "txt";
	$table["15"] = "uc_members";
	$table["16"] = "xiaomi_com";
	//定义索引表名
	$index["1"] = "uid";
	$index["2"] = "id";
	$index["3"] = "uid";
	$index["4"] = "uid";
	$index["5"] = "id";
	$index["6"] = "id";
	$index["7"] = "uid";
	$index["8"] = "uid";
	$index["9"] = "uid";
	$index["10"] = "uid";
	$index["11"] = "uid";
	$index["12"] = "use_id";
	$index["13"] = "uid";
	$index["14"] = "id";
	$index["15"] = "uid";
	$index["16"] = "id";
    if(isset($_GET['quest']))	//如果搜索了条目
	{
		if($_GET['md5']==1)	//16位md5
		{
			$quest=substr(md5($quest),8,16);
		}
		if($_GET['md5']==2)	//32位md5
		{
			$quest=md5($quest);
		}
		$cl = new SphinxClient();
		// 返回结果设置
		$opts = array
		(
			"before_match"		=> "<font color=red>",
			"after_match"		=> "</font>",
			"chunk_separator"	=> " ... ",
			"limit"				=> 256,
			"around"			=> 5,
		);
		$cl->SetServer ('127.0.0.1', SERVER_PORT);
		$cl->SetConnectTimeout ( CONNECT_TIMEOUT );
		$cl->SetArrayResult ( true );
		// 设置是否全文匹配
		if(isset($_GET['full']))
		{
			$cl->SetMatchMode(SPH_MATCH_ALL);
		}
		else
		{
			$cl->SetMatchMode(SPH_MATCH_ANY);
		}
		//设置检索位置
		if(isset($_GET['page']))
		{
			$page = intval(trim($_GET['page'])) > 0 ? intval(trim($_GET['page']))-1 : 0;
			$page = $page * PAGE_NUM;
		}
		
		$cl->setLimits($page,PAGE_NUM,MAX_NUM);
		$res = $cl->query ( ".{$quest}.", "*" );
		
		mysql_connect("localhost",USERNAME,PASSWORD); 
		mysql_select_db(DATABASE);	
		
		if ( is_array($res["matches"]) )
		{
			mysql_query("set names utf8");
			for (; $num < count($res["matches"]) ; $num++ )
			{
				$uid = $res["matches"][$num]["id"];	//取得第一列数据
				$table_id = $res["matches"][$num]["attrs"]["table_id"];	//取得table_id
				$table_name = $table[$table_id];
				$sql = "SELECT * FROM {$table_name} WHERE {$index[$table_id]} = {$uid}";
				$rets[$num] = mysql_query($sql);
			}
		}
	}
?>

<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="zh-CN">
<head>
<title>The Web of Answers</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<link rel="stylesheet" type="text/css" href="html/default.css" />
	<style type="text/css">
		body,td,th 
		{
			color: #FFF;
		}
		a:link 
		{
			color: #0C0;
			text-decoration: none;
		}
		body 
		{
			background-color: #000;
		}
		a:visited 
		{
			text-decoration: none;
			color: #999;
		}
		a:hover 
		{
			text-decoration: none;
		}
		a:active 
		{
			text-decoration: none;
			color: #F00;
		}
		.pages
		{
			clear: both;
			text-align: right;
			padding: 8px 0;
		}
		.pages a
		{
			display: inline-block;
			height: 20px;
			line-height: 20px;
			border: 1px solid #228B22;
			padding: 0 8px;
			color: #228B22;
			margin: 5px 2px;
			background: #2F2F2F;
		}
		.pages a:hover
		{
			background: #228B22;
			color: white;
		}
		.pages span 
		{
			display: inline-block;
			height: 20px;
			line-height: 20px;
			border: 1px solid #228B22;
			padding: 0 8px;
			margin: 5px 2px;
			background: #228B22; /*#228B22;*/
			color: white;	
		}
		#create_form label
		{
			margin-left: 10px;
		}
		#create_form em
		{
			margin-left: 60px;
		}
    </style>
<script>
<!--
	function check(form)
	{
		if(form.quest.value=="")
		{
			alert("不能为空值！");
			form.quest.focus();
			return false;
		}
	}
-->
</script>
</head>

<body>
	<div id="container">
		<div id="header"><h1>The Web of Answers</h1></div><br /><br />
		
		<div id="content">
			<form name="form" method="GET">
				<div id="create_form">
					<p><em></em>
						<label for=""><input type="checkbox" name="full" value="1" <?php echo !empty($_GET['full'])?'checked':'';?> />完整匹配</label>
						<label></label>
						<label for=""><input type="checkbox" name="md5" value="1" <?php echo !empty($_GET['md5'])?'checked':'';?> />MD5匹配</label>
					</p>
					<p style="text-align:center;margin:0 auto;">
						<label><input class="inurl" size="26" id="unurl" name="quest" value="<?php echo strip_tags(trim($_GET['quest']));?>" /></label>
						<span class="but"><input onclick="check(form)" type="submit" value="Search" class="submit" /></span>
					</p>
				</div>
			</form>
			
			<?php	
				if ($num > 0)	//找到了结果
				{
					echo "<br/>找到与&nbsp{$quest}&nbsp相关的结果 {$res[total_found]} 个。用时 {$res[time]} 秒。<ol start=\"" . (string)($page+1) . "\">";
					for ($no = 0 ; $no < $num ; $no++)	//显示结果
					{
						$row = mysql_fetch_assoc($rets[$no]);	//取得单行数据
						$keys = array_keys($row);	//取得列名
						$table_id = $res["matches"][$no]["attrs"]["table_id"];
						$table_name = $table[$table_id];	//取得表名
						$retContent = $cl->buildExcerpts($row,$table_name,$quest,$opts);	//取得高亮关键字后的数据
						echo "<li><font color=#00CD00>Table&nbsp;:&nbsp;{$table_name}</font><br /><br />";
						//输出信息
						for ($i = 0 ; $i < count($row) ; $i++)
						{
							$column_name = $keys[$i];	//取得本条列名
							if ($column_name == $index[$res["matches"][$no]["attrs"]["table_id"]])	//不输出行数
								continue;
							if (empty($retContent[$i]))	//不输出空白数据
								continue;
							echo $column_name;	//输出列名
							echo "&nbsp;:&nbsp;";
							echo $retContent[$i];	//输出高亮关键字后的数据
							echo "<br />";
						}
						echo '<br /></li>';
					}
					echo '</ol>';
				} 
				elseif (isset($_GET['quest']))
				{
					echo "<br/>找不到与&nbsp{$quest}&nbsp相关的结果。请更换其他关键词试试。";				
				}
			?>
			
			<div class="pages">
				<?php
					if($num != 0)
					{
						//取得页面数
						$pagecount = (int)($res[total_found] / PAGE_NUM);
						if(($res[total_found] % PAGE_NUM)!=0)	//找到的条目不足两页
						{
							$pagecount = $pagecount + 1;
						}
						if($pagecount > MAX_NUM/PAGE_NUM)	//显示的条目不超过限制
						{
							$pagecount = MAX_NUM/PAGE_NUM;
						}
						//设置高亮页数
						$highlightid = intval(trim($_GET['page']))>1 ? intval(trim($_GET['page'])) : 1;
						//设置页面按钮
						for ($pageno=1; $pageno <= $pagecount; $pageno++) 
						{ 
							if($highlightid==$pageno)
							{
								echo "<span>{$pageno}</span>";
							}
							else
							{
								echo "<a href=\"?quest={$quest}&page={$pageno}&md5={$md5}&full={$full}\">{$pageno}</a>";
							}
						}				
					}
				?>
			</div>
		</div>
	</div>
</body>
</html>